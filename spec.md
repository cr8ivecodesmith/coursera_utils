Utilities specifications
===

## generate\_document.py

### **Description**

A script that will create a new document based on given reference documents.
The document created will be using AI guided by prompts found in a config file.

### **Inputs**

**Required:**
- Document type (a string that matches a config in a `documents.toml` file)
- Output filename (in markdown)
- List of files and/or directories containing reference documents. Reference
  files can be anything that can be opened as plain text.

**Optional:**
- `--extensions`: Customize what file extensions to process. By default, only
txt and markdown files will be processed. This can be a list of values that we
will use to filter the files types to process.
- `--level-limit`: Limits the directory level to traverse when looking for
text files. Defaults to 0, for no limit. Any integer >= 1 will traverse
accordingly.
- `--config`: Path to a toml config file. Defaults to looking for a 
  `documents.toml` file where the script is run, then inside script's app
  module. Raises an error when no config is found with valid content.

**`documents.toml`**

This config contains document types to generate. The following will be provided
as defaults:

- keywords: Picks out topics or subjects from the provided files with
  A brief description for each based on how it was used or defined. Groups
  keywords found by file.
- reading\_assignment: Creates a reading article for studying from the provided
  files. Each file will be a main heading. Provide summary, key ideas, 
  questions, stories. Prefer paraphrasing directly from the files.
- book: Creates a book from the provided files. Each file becomes a chapter.
  Keeping faithful to the text is important. Reorganize into coherent
  sentences > paragraphs > topics. Decide whether to use an instructional or
  story telling voice depending on context, and keep it consistent.

Each config should have the following sections:
- model: To customize what gpt model to use.
- description: Describes what the config is for.
- prompt: Used as guidance for generating the document.


## text\_combiner.py

### **Description**

A script that will combine text files into one.

- Required: Output filename
- Required: Accepts a list of files and/or list of directories containing text files.
- Optional:
  - `--extensions`: Customize what file extensions to process. By default, only
    txt files will be processed. This can be a list of values that we will use
    to filter the files types to process.
  - `--level-limit`: Limits the directory level to traverse when looking for
    text files. Defaults to 0, for no limit. Any integer >= 1 will traverse
    accordingly.
  - `--combine-by`: Sets how the files will be combined.
    - `EOF`: End of file. Combines files as they are.
    - `NEW`: New line. The contents of the next file are appended on the next
      line. This is the default.
  - `--order-by`: Orders the files found or given. Defaults to None to support
    the order of how the files were given in the parameter and for files in
    directories that were explicitly ordered. Otherwise provide option for:
    - `[-]created`: Created time asc or desc
    - `[-]modified`: Modified time asc or desc
    - `[-]name`: Name asc or desc
  - `--section-title`: Inserts a text that serves to seperate the contents of
    one file from the next. This will ignore the `--combine-by` option as this
    will always insert a new line before and after the section title:
    ```
    ...end of file 1 contents.

    File 2 Section Title

    File 2 contents...
    ```
    - `filename`: Uses the filename as the section title. This is default.
    - `smart-filename`: Uses AI to generate a section title based on the
      filename.
    - `smart-content`: Uses AI to generate a section title based on the content
  - `--section-title-format`: Sets the format of the section title. If not set,
    we will just use whatever is generated by the section title.
    - `title`: Use title case.
    - `lower`: Use lower case.
    - `upper`: Use upper case.
  - `--section-title-heading`: Customize the heading modifier of the section
    title. For now this is markdown headings only. Default is none.


## markdown_to_pdf.py

### **Description**

Convert one or more Markdown files into a single PDF with configurable paper size, margins, optional table of contents, and an optional title page. Uses WeasyPrint (pure Python HTML→PDF) for portability and simplicity on Linux.

### **Python Compatibility**

- Target: Python 3.8+ (consistent with repo usage). Suggested libs support 3.8–3.12.
- Python libs:
  - `markdown-it-py` (Markdown→HTML)
  - `weasyprint` (HTML→PDF)
  - `jinja2` (title page templating)
  - `pygments` (code highlight CSS)

### **External System Libraries (Linux)**

- WeasyPrint requires Cairo, Pango, and related libs (see README for apt packages).

### **Inputs**

**Required:**
- Output PDF path
- One or more input Markdown files or directories (recursively discovering `*.md` by default)

**Optional:**
- `--paper-size {letter,a4,legal,a5}`: Default `letter`.
- `--orientation {portrait,landscape}`: Default `portrait`.
- `--margin` shorthand (CSS-like, accepts units: `in`, `mm`, `cm`, `pt`), e.g., `--margin 1in` or `--margin "1in 0.75in"`.
  - Edge-specific: `--margin-top`, `--margin-right`, `--margin-bottom`, `--margin-left` (overrides shorthand).
- `--toc/--no-toc`: Include table of contents; default off.
- `--toc-depth N`: Max heading level for TOC; default 3.
- `--title-page`: Include a title page. Use with:
  - `--title`, `--subtitle`, `--author`, `--date` (defaults to today in local timezone)
  - `--title-template PATH` (Jinja2 template)
- `--ai-title`: Generate title page fields with AI (optional). Uses repo’s `load_client()`.
  - `--ai-model MODEL`
  - `--ai-prompt PATH`
  - `--ai-max-tokens`, `--ai-temperature`
- `--css PATH`: Custom stylesheet.
- `--highlight-style {default,monokai,github} | --highlight-css PATH`: Code highlighting.
- `--resources PATH`: Base path for images and assets.
- `--extensions ext1 ext2 ...`: Additional Markdown extensions to pass to parser.
- `--level-limit N`: When inputs include directories, limit recursion depth.
- `--sort {name,created,modified}` with optional `-` prefix for desc.
- `--dry-run`: Print resolved plan without generating output.
- `--verbose`: Print detailed steps.

### **Behavior**

- Discovery: Accept files and/or directories; default extensions `md`, `markdown`. Deterministic sort unless overridden.
- Concatenation: Preserve input order. Assemble a single HTML document from title page (optional), TOC (optional), and Markdown sections converted via `markdown-it-py`.
- Title page:
  - If `--title-page` and fields provided, render via Jinja2 template.
  - If `--ai-title`, call `load_client()` and prompt the model using the first N lines of the first Markdown (configurable) and/or filenames to infer `title`, `subtitle`, `author`.
  - Sanitize AI output; trim to reasonable length; escape HTML.
- Table of contents: Generate from parsed headings up to `--toc-depth`; link with anchors in the assembled HTML.
- Margins, paper, orientation: Apply via CSS `@page` rules; generate stylesheet from options.
- Styles: Ship a default print CSS; allow custom CSS via `--css` to override/extend defaults.
- Output: Write only to the explicit output path. Use a temp build dir under OS temp; clean up on success.
- Errors: Fail fast with precise messages about missing system libs for WeasyPrint or invalid inputs. Offer remediation hints.

### **Configuration Defaults**

- Default paper size: `letter`
- Default margins: `1cm` all sides
- Default orientation: `portrait`
- Default TOC: off
- Default title template: simple centered layout with document metadata; single page
- Optional `app/pdf_defaults.toml` for persistent defaults:
  - `[defaults] paper_size = "a4"; margin = "1cm"; orientation = "portrait"; toc = false
  - `[style] css = "app/resources/print.css"`
  - `[ai] model = "gpt-4o-mini"; max_tokens = 200; temperature = 0.3`

### **CLI Usage**

- `python -m app.markdown_to_pdf OUTPUT.pdf INPUTS... [options]`
- Examples:
  - `python -m app.markdown_to_pdf out.pdf notes.md --toc --paper-size a4`
  - `python -m app.markdown_to_pdf out.pdf docs/ --level-limit 2 --margin "1in 0.75in"`
  - `python -m app.markdown_to_pdf out.pdf intro.md chapter*.md --title-page --title "My Guide" --author "Me"`
  - `python -m app.markdown_to_pdf out.pdf README.md --ai-title --toc`

### **Implementation Outline**

- Parse args with `argparse`; keep pure helpers for:
  - Path discovery (`iter_markdown_files`), sorting, and recursion
  - Margin/paper/orientation normalization to CSS `@page` rules
  - Title page rendering with Jinja2
  - Optional AI title generation using `load_client()`; isolated and mockable
  - Markdown→HTML with `markdown-it-py`; assemble single HTML with anchors
  - TOC generation from headings
- Render to PDF using `weasyprint.HTML(string=..., base_url=resources_dir).write_pdf(stylesheets=[...])`.
- Keep I/O isolated in `main()`; core logic pure and unit-testable.

### **Testing**

- Unit tests (no system tools required beyond Python libs):
  - Arg parsing and option normalization (paper/margins/orientation/TOC)
  - Title page templating given explicit fields
  - AI title path with a stubbed client returning deterministic fields
  - TOC generation (given headings produces correct anchors)
  - CSS generation for `@page` with margins and paper size (snapshot)
- Optional integration test marked and skipped if `weasyprint` is not importable

### **Error Messages & Remediation**

- Missing WeasyPrint or system libraries: hint to install Cairo/Pango on Debian/Ubuntu
- Absent `OPENAI_API_KEY` when `--ai-title`: explain `.env` support via `load_client()`

### **Security & Performance**

- No shell interpolation; all operations stay within Python
- Sanitize user paths; disallow writing outside the specified output
- Stream file reads; avoid loading extremely large Markdown into memory at once when concatenating
- Deterministic output given inputs; all randomness/AI optional and explicit

## quizzer.py

### **Description**

Interactive terminal quiz tool that extracts topics and multiple‑choice questions from Markdown sources, stores a local bank, runs practice sessions, and summarizes weak areas for review. AI is optional and configurable; artifacts are human‑editable.

### **Python Compatibility**

- Target: Python 3.8+.
- Optional UI: `textual` for a richer TUI; pure CLI fallback when not installed.

### **CLI**

- Base: `python -m app.quizzer [command] [options]`
- Global options:
  - `--config PATH`: Path to `quizzer.toml` (default: look in CWD, then `app/`).
  - `--out DIR`: Artifacts directory (default: `.quizzer/<quiz_name>` under CWD).
  - `--model NAME`: Override AI model for this run.
  - `--seed INT`: Global RNG seed for deterministic selection.
  - `--dry-run`: Print plan without writing files or calling AI.
  - `--verbose`: Print detailed steps.
- Commands:
  - `init QUIZ_NAME`: Create `quizzer.toml` template for a quiz.
  - `topics generate QUIZ_NAME [--force] [--limit N] [--extensions md markdown] [--level-limit N]`: Extract and persist topics.
  - `topics list QUIZ_NAME [--filter STR]`: List known topics.
  - `questions generate QUIZ_NAME [--per-topic N] [--type mcq] [--regenerate-missing]`: Generate and validate questions with answers.
  - `questions list QUIZ_NAME [--topics TOPIC... ]`: List questions in bank.
  - `start QUIZ_NAME [--num N] [--mix balanced|random|weakness] [--topic TOPIC ...] [--resume] [--shuffle] [--explain|--no-explain] [--time-limit SEC]`: Run a quiz session.
  - `review QUIZ_NAME [--session ID]`: Re‑quiz wrong/weak topics from a prior session.
  - `report QUIZ_NAME [--session ID]`: Show session summary and per‑topic stats.

### **Configuration: `quizzer.toml`**

- Layout: multiple quiz definitions under `[quiz.<name>]`.
- Required fields under each quiz:
  - `sources = ["./path", ...]`: Files or directories (recursively discover `*.md`, `*.markdown`).
  - `types = ["mcq"]`: Supported question types; start with `mcq`.
- Recommended fields:
  - `materials = ["./refs/reading.txt", ...]`: Optional reference texts for explanations.
  - `per_topic = 3`: Default questions to generate per topic.
  - `ensure_coverage = true`: Ask each topic at least once before repeats.
  - `focus_topics = ["Topic A", ...]`: Limit generation/selection to these topics.
  - `topic_seed = 0` and `question_seed = 0`: Deterministic AI generation when set.
  - `user_background = "..."`: Used for analogies in explanations.
  - `[ai] model = "gpt-4o-mini"; temperature = 0.2; max_tokens = 600; system_prompt = "..."`.
  - `[storage] out_dir = ".quizzer/<name>"`: Override artifacts directory.

### **Artifacts & Schemas**

- Topics: `topics.jsonl` (one per line)
  - `{ "id": "slug", "name": "Topic", "description": "...", "source_paths": ["..."], "created_at": "ISO8601" }`
- Questions: `questions.jsonl` (one per line)
  - `{ "id": "uuid", "topic_id": "slug", "type": "mcq", "stem": "...", "choices": [{"key":"A","text":"..."},...], "answer": "B", "explanation": "...", "sources": ["file.md#h3"], "version": 1, "created_at": "ISO8601" }`
- Sessions: `sessions/<timestamp>/`
  - `responses.jsonl`: `{ "question_id": "...", "given": "A", "correct": true, "duration_sec": 7.2, "topic_id": "..." }`
  - `summary.json`: `{ "id": "...", "started_at": "...", "ended_at": "...", "total": 20, "correct": 16, "accuracy": 0.8, "per_topic": {"slug": {"asked": 3, "correct": 2}}, "weak_topics": ["slug"], "mix": "balanced" }`

### **Behavior**

- Topic generation:
  - Parse sources deterministically; deduplicate by normalized slug; keep short description per topic; append‑only JSONL to allow manual edits/merges.
  - Respect `focus_topics` when present; otherwise discover from content and headings.
  - Optional AI assist: when enabled, prompt a model with short snippets to propose topic names/descriptions; merge with heuristic headings by slug, prefer clearer names, and keep `source_paths`.
- Question generation:
  - Generate at least `per_topic` MCQs per topic; enforce single correct answer; plausible distractors; stem and choices concise; include brief explanation and source refs when possible.
  - Validate format (letters A–D unique, exactly one answer, non‑empty fields). Refuse to save invalid entries with actionable error messages.
- Selection strategy (`start`):
  - `balanced`: Ensure each topic appears once before repeats; use RNG with `--seed` when provided.
  - `random`: Uniform random over all questions.
  - `weakness`: Weight selection toward topics with lower accuracy in recent summaries.
  - Filters: `--topic` limits pool; `focus_topics` from config applies by default.
- Session flow:
  - Accept answers as letter (`a`/`A`) or choice text; allow `skip`, `back`, `quit`.
  - Show correctness, short explanation, and optional source snippet.
  - Track progress (e.g., `12/20 • 80%`), elapsed time, and per‑topic stats live.
  - On completion, write `responses.jsonl` and `summary.json`; print a concise report and list weak topics.
- UI:
  - If `textual` is available, present a TUI with keyboard navigation; otherwise use simple line‑oriented prompts.

### **Implementation Outline**

- Pure helpers (unit testable):
  - File discovery (`iter_quiz_files`), topic extraction, question validation, selection algorithms, scoring and summary aggregation, JSONL IO utils.
  - AI topic extraction helper `ai_extract_topics(sources, k, client, prompt, model, temperature, seed)` that returns suggested topics; merging logic lives in `extract_topics(use_ai=True, ...)`.
  - Seed control via `random.Random` instances passed explicitly.
- I/O edges and CLI (`main()`):
  - Argparse subcommands; minimal side effects; all paths via `pathlib.Path`.
  - AI calls isolated in `ai.py` with `load_client()`; easy to stub.

### **Testing**

- Unit tests with stubbed AI:
  - Topic extraction from simple Markdown inputs (headings, bullet lists)
  - Question validator catches bad keys, multiple answers, empty fields
  - Selection strategies honor coverage, weakness weighting, and seeds
  - Summary aggregation computes per‑topic accuracy correctly
- Integration‑light tests:
  - CLI parse for `init`, `topics generate`, `questions generate --per-topic 2`, `start --num 3 --mix balanced --dry-run`
  - JSONL read/write round‑trip for topics/questions

### **Error Messages & Remediation**

- Missing or invalid `quizzer.toml`: point to `init QUIZ_NAME` to scaffold.
- No sources resolved: suggest `--extensions`, `--level-limit`, or fix paths.
- Invalid question format: show precise line and reason; suggest `questions validate`.
- AI errors: explain `.env`/`OPENAI_API_KEY` support via `load_client()` and retry options.

### **Security & Privacy**

- No shell invocation; sanitize/resolve paths; never write outside `--out`.
- Offline‑friendly: all AI calls optional; tests stub external clients.

### **Technology**

- AI via OpenAI client from `load_client()`; light retries/backoff; timeouts configurable.
- Optional `textual` for TUI; otherwise standard input/print for CLI.

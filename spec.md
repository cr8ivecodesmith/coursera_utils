Utilities specifications
===

## generate\_document.py

### **Description**

A script that will create a new document based on given reference documents.
The document created will be using AI guided by prompts found in a config file.

### **Inputs**

**Required:**
- Document type (a string that matches a config in a `documents.toml` file)
- Output filename (in markdown)
- List of files and/or directories containing reference documents. Reference
  files can be anything that can be opened as plain text.

**Optional:**
- `--extensions`: Customize what file extensions to process. By default, only
txt and markdown files will be processed. This can be a list of values that we
will use to filter the files types to process.
- `--level-limit`: Limits the directory level to traverse when looking for
text files. Defaults to 0, for no limit. Any integer >= 1 will traverse
accordingly.
- `--config`: Path to a toml config file. Defaults to looking for a 
  `documents.toml` file where the script is run, then inside script's app
  module. Raises an error when no config is found with valid content.

**`documents.toml`**

This config contains document types to generate. The following will be provided
as defaults:

- keywords: Picks out topics or subjects from the provided files with
  A brief description for each based on how it was used or defined. Groups
  keywords found by file.
- reading\_assignment: Creates a reading article for studying from the provided
  files. Each file will be a main heading. Provide summary, key ideas, 
  questions, stories. Prefer paraphrasing directly from the files.
- book: Creates a book from the provided files. Each file becomes a chapter.
  Keeping faithful to the text is important. Reorganize into coherent
  sentences > paragraphs > topics. Decide whether to use an instructional or
  story telling voice depending on context, and keep it consistent.

Each config should have the following sections:
- model: To customize what gpt model to use.
- description: Describes what the config is for.
- prompt: Used as guidance for generating the document.


## text\_combiner.py

### **Description**

A script that will combine text files into one.

- Required: Output filename
- Required: Accepts a list of files and/or list of directories containing text files.
- Optional:
  - `--extensions`: Customize what file extensions to process. By default, only
    txt files will be processed. This can be a list of values that we will use
    to filter the files types to process.
  - `--level-limit`: Limits the directory level to traverse when looking for
    text files. Defaults to 0, for no limit. Any integer >= 1 will traverse
    accordingly.
  - `--combine-by`: Sets how the files will be combined.
    - `EOF`: End of file. Combines files as they are.
    - `NEW`: New line. The contents of the next file are appended on the next
      line. This is the default.
  - `--order-by`: Orders the files found or given. Defaults to None to support
    the order of how the files were given in the parameter and for files in
    directories that were explicitly ordered. Otherwise provide option for:
    - `[-]created`: Created time asc or desc
    - `[-]modified`: Modified time asc or desc
    - `[-]name`: Name asc or desc
  - `--section-title`: Inserts a text that serves to seperate the contents of
    one file from the next. This will ignore the `--combine-by` option as this
    will always insert a new line before and after the section title:
    ```
    ...end of file 1 contents.

    File 2 Section Title

    File 2 contents...
    ```
    - `filename`: Uses the filename as the section title. This is default.
    - `smart-filename`: Uses AI to generate a section title based on the
      filename.
    - `smart-content`: Uses AI to generate a section title based on the content
  - `--section-title-format`: Sets the format of the section title. If not set,
    we will just use whatever is generated by the section title.
    - `title`: Use title case.
    - `lower`: Use lower case.
    - `upper`: Use upper case.
  - `--section-title-heading`: Customize the heading modifier of the section
    title. For now this is markdown headings only. Default is none.


## markdown_to_pdf.py

### **Description**

Convert one or more Markdown files into a single PDF with configurable paper size, margins, optional table of contents, and an optional title page. Uses WeasyPrint (pure Python HTML→PDF) for portability and simplicity on Linux.

### **Python Compatibility**

- Target: Python 3.8+ (consistent with repo usage). Suggested libs support 3.8–3.12.
- Python libs:
  - `markdown-it-py` (Markdown→HTML)
  - `weasyprint` (HTML→PDF)
  - `jinja2` (title page templating)
  - `pygments` (code highlight CSS)

### **External System Libraries (Linux)**

- WeasyPrint requires Cairo, Pango, and related libs (see README for apt packages).

### **Inputs**

**Required:**
- Output PDF path
- One or more input Markdown files or directories (recursively discovering `*.md` by default)

**Optional:**
- `--paper-size {letter,a4,legal,a5}`: Default `letter`.
- `--orientation {portrait,landscape}`: Default `portrait`.
- `--margin` shorthand (CSS-like, accepts units: `in`, `mm`, `cm`, `pt`), e.g., `--margin 1in` or `--margin "1in 0.75in"`.
  - Edge-specific: `--margin-top`, `--margin-right`, `--margin-bottom`, `--margin-left` (overrides shorthand).
- `--toc/--no-toc`: Include table of contents; default off.
- `--toc-depth N`: Max heading level for TOC; default 3.
- `--title-page`: Include a title page. Use with:
  - `--title`, `--subtitle`, `--author`, `--date` (defaults to today in local timezone)
  - `--title-template PATH` (Jinja2 template)
- `--ai-title`: Generate title page fields with AI (optional). Uses repo’s `load_client()`.
  - `--ai-model MODEL`
  - `--ai-prompt PATH`
  - `--ai-max-tokens`, `--ai-temperature`
- `--css PATH`: Custom stylesheet.
- `--highlight-style {default,monokai,github} | --highlight-css PATH`: Code highlighting.
- `--resources PATH`: Base path for images and assets.
- `--extensions ext1 ext2 ...`: Additional Markdown extensions to pass to parser.
- `--level-limit N`: When inputs include directories, limit recursion depth.
- `--sort {name,created,modified}` with optional `-` prefix for desc.
- `--dry-run`: Print resolved plan without generating output.
- `--verbose`: Print detailed steps.

### **Behavior**

- Discovery: Accept files and/or directories; default extensions `md`, `markdown`. Deterministic sort unless overridden.
- Concatenation: Preserve input order. Assemble a single HTML document from title page (optional), TOC (optional), and Markdown sections converted via `markdown-it-py`.
- Title page:
  - If `--title-page` and fields provided, render via Jinja2 template.
  - If `--ai-title`, call `load_client()` and prompt the model using the first N lines of the first Markdown (configurable) and/or filenames to infer `title`, `subtitle`, `author`.
  - Sanitize AI output; trim to reasonable length; escape HTML.
- Table of contents: Generate from parsed headings up to `--toc-depth`; link with anchors in the assembled HTML.
- Margins, paper, orientation: Apply via CSS `@page` rules; generate stylesheet from options.
- Styles: Ship a default print CSS; allow custom CSS via `--css` to override/extend defaults.
- Output: Write only to the explicit output path. Use a temp build dir under OS temp; clean up on success.
- Errors: Fail fast with precise messages about missing system libs for WeasyPrint or invalid inputs. Offer remediation hints.

### **Configuration Defaults**

- Default paper size: `letter`
- Default margins: `1cm` all sides
- Default orientation: `portrait`
- Default TOC: off
- Default title template: simple centered layout with document metadata; single page
- Optional `app/pdf_defaults.toml` for persistent defaults:
  - `[defaults] paper_size = "a4"; margin = "1cm"; orientation = "portrait"; toc = false
  - `[style] css = "app/resources/print.css"`
  - `[ai] model = "gpt-4o-mini"; max_tokens = 200; temperature = 0.3`

### **CLI Usage**

- `python -m app.markdown_to_pdf OUTPUT.pdf INPUTS... [options]`
- Examples:
  - `python -m app.markdown_to_pdf out.pdf notes.md --toc --paper-size a4`
  - `python -m app.markdown_to_pdf out.pdf docs/ --level-limit 2 --margin "1in 0.75in"`
  - `python -m app.markdown_to_pdf out.pdf intro.md chapter*.md --title-page --title "My Guide" --author "Me"`
  - `python -m app.markdown_to_pdf out.pdf README.md --ai-title --toc`

### **Implementation Outline**

- Parse args with `argparse`; keep pure helpers for:
  - Path discovery (`iter_markdown_files`), sorting, and recursion
  - Margin/paper/orientation normalization to CSS `@page` rules
  - Title page rendering with Jinja2
  - Optional AI title generation using `load_client()`; isolated and mockable
  - Markdown→HTML with `markdown-it-py`; assemble single HTML with anchors
  - TOC generation from headings
- Render to PDF using `weasyprint.HTML(string=..., base_url=resources_dir).write_pdf(stylesheets=[...])`.
- Keep I/O isolated in `main()`; core logic pure and unit-testable.

### **Testing**

- Unit tests (no system tools required beyond Python libs):
  - Arg parsing and option normalization (paper/margins/orientation/TOC)
  - Title page templating given explicit fields
  - AI title path with a stubbed client returning deterministic fields
  - TOC generation (given headings produces correct anchors)
  - CSS generation for `@page` with margins and paper size (snapshot)
- Optional integration test marked and skipped if `weasyprint` is not importable

### **Error Messages & Remediation**

- Missing WeasyPrint or system libraries: hint to install Cairo/Pango on Debian/Ubuntu
- Absent `OPENAI_API_KEY` when `--ai-title`: explain `.env` support via `load_client()`

### **Security & Performance**

- No shell interpolation; all operations stay within Python
- Sanitize user paths; disallow writing outside the specified output
- Stream file reads; avoid loading extremely large Markdown into memory at once when concatenating
- Deterministic output given inputs; all randomness/AI optional and explicit

## quizzer.py

### **Description**

An interactive script that will quiz based on given source files.

### **Inputs**

**Required:**

- Quiz name taken from the a section provided in the config file.

**Optional:**

- Generate topics -- Generates topic file from the quiz source files
- List topics -- Lists identified topics
- Generate questions -- Generates questions and answer keys file based on configuration.
- Questions per topic -- Number of questions to generate per topic. Default 3.
- Create quizzer template -- Generates a quizzer.toml template file that the user
  can edit.


**quizzer.toml**

Contains configuration for different kinds of quiz separated by sections. This
configuration will not be provided by default and must be provided by the user.

The ff. configurations will be needed:
- Quiz source files: One or more input Markdown files or directories (recursively discovering `*.md` by default). This will be used for the questions.
- Material references: Optional, file path. These can be raw transcript of video or audio lessons, books, articles, etc. When available, these can be used when the student wants to discuss a topic to further their understanding. Otherwise, the AI tutor will attempt to search for materials online preferring high value sources such as wikipedia. For now we'll only support text readable files.
- Quiz types: Must support multiple choice for now.
- Number of questions: Number of questions per quiz type.
- Ensure complete coverage: Optional, boolean, defaults true. Ideally, at least all topics
  can be asked at least once. If this setting is false, then in the event of 
  (questions < topics) we just accept that. If this setting is true, we ensure that at least
  all topics are asked once regardless of the number of questions setting.
- Focus topics: Optional, list. Topics are first identified from the source files and stored
  in a file. This will be used by the AI tutor to ensure coverage. When this is set,
  It only quizzes on the given topics.
- Topic seed: Optional, int.
- Question seed: Optional, int.
- User background: Optional, long string. Can be used by the AI tutor for metaphors and
  analogies when explaining concepts to the user.


### **Behavior**

- When generating topics, ensure the topic has not yet been identified. Likewise,
  note that there can be more than one topic file.
- When generating questions, ensure all topics are covered. Note that there can
  be more than one question file.
- When selecting questions and topics, randomly select them but ensure a balanced
  distribution or prioritize topics that have not been
  covered. Note if a random seed is set. Ultimately, the AI tutor must also
  take into account the user's weak areas (refers to previous summary reports
  if available) and prefer those during the question prep process.
- Ensure a consistent formatting of question format for multiple choice:
  ```
  Topic: <topic>
  Question: <Question>
  Choices:
  A) <...>
  B) <...>
  C) <...>
  D) <...>
  ```
  - Provide at least 2-4 options as applicable.
- When evaluating the user's answer, provide a brief explanation on why it is
  correct or incorrect.
- Ask the user if they want to talk about the topic further or move on to the
  question. This is where the material preferences and user background come in
  handy.
- Keep track and show quiz progress.
- At the end of the quiz, summarize the user's progress. Especially on topics
  that needs improvement. Note also the topics that have been covered and not.
  This can be used by the user later (and the AI tutor) on so they can focus on those.
  Save this report in a file (json).
- Keep a consistent directory where these artifact files are stored as well as
  naming conventions.

### **Technology**

- This will rely heavily on OpenAI for the AI tutor parts
- The UI will be a terminal UI using `textual`
